# WX7V Foxhunt Controller Project Rules

## Project Context
This project implements a dual-band radio "fox" (hidden transmitter) using a Teensy 4.1 microcontroller and Baofeng UV-5R radio for amateur radio foxhunt events.

## Development Environment
- **IDE:** Arduino IDE 2.3.7
- **Board:** Teensy 4.1 (with Teensyduino add-on)
- **Compilation:** All code must compile successfully in Arduino IDE 2.3.7
- **Upload:** Use Arduino IDE's upload function with Teensy Loader integration
- **Testing:** Serial Monitor at 115200 baud for debugging and output verification

## CRITICAL: Always Read Reference Documentation First
- **ALWAYS** read `@Hardware_Reference.md` and `@Software_Reference.md` before writing any code
- **Hardware_Reference.md** contains hardware constraints, pinout mappings, wiring diagrams, voltage levels, and component specifications
- **Software_Reference.md** contains programming requirements, architecture patterns, safety interlocks, and code examples
- Never assume pin assignments, voltage levels, or timing requirements - always verify against these references

## Documentation Requirements

### File Creation Policy:
- **DO NOT** create unnecessary AI-generated markdown files (*.mdc, *_SETUP.md, etc.)
- **DO NOT** create step-by-step setup guides unless explicitly requested
- **ONLY** update existing documentation files (README.md, specification, hardware reference)
- **AVOID** creating temporary helper files that clutter the repository
- If documentation is needed, update existing files or ask first

### After Major Features or Milestones:
1. **UPDATE** `@Hardware_Reference.md` when hardware changes:
   - Pin assignment modifications
   - Component value changes
   - Power consumption measurements
   - Wiring or circuit updates
   - Performance characteristics

2. **UPDATE** `@Software_Reference.md` when code architecture changes:
   - New features implemented
   - State machine modifications
   - Timing requirement changes
   - Safety interlock updates
   - Configuration parameter changes

3. **TRACK** all code migrations/refactoring:
   - Document breaking changes
   - List deprecated functions
   - Note library version updates
   - Update code examples in Software_Reference.md

## Coding Standards

### Architecture Requirements:
1. **NON-BLOCKING DESIGN MANDATORY**
   - Use `millis()` for timing, NEVER `delay()` in production code
   - Implement state machines for complex sequences
   - Keep `loop()` function responsive (< 10ms execution time)
   - Allow concurrent task handling (LED blink, sensor checks, etc.)

2. **Safety First:**
   - Implement watchdog timer to prevent stuck PTT
   - Duty cycle management to prevent radio overheating
   - Voltage monitoring for battery protection
   - Graceful degradation on errors

### Naming Conventions:
```cpp
// Constants: UPPER_CASE_WITH_UNDERSCORES
const int PTT_PIN = 2;
const long TRANSMIT_INTERVAL = 60000;

// Variables: camelCase
unsigned long lastTransmitTime = 0;
bool isPttActive = false;

// Functions: camelCase with descriptive names
void keyRadio();
void sendMorseCode(const char* text);
unsigned long calculateDutyCycle();
```

### Comments:
- Document WHY, not WHAT (code should be self-documenting)
- Note hardware timing constraints
- Reference specification sections where applicable
- Mark safety-critical sections clearly

### Error Handling:
```cpp
// Check for valid states before operations
if (isPttActive && (millis() - pttStartTime > MAX_PTT_TIME)) {
    // SAFETY: Force PTT off after timeout
    emergencyPttRelease();
    logError("PTT timeout exceeded");
}
```

## Technical References
For all hardware and software specifications, see:
- **Arduino IDE configuration:** See `Hardware_Reference.md` → "Arduino IDE Configuration"
- **Testing requirements:** See `Software_Reference.md` → "Testing Checklist"  
- **Required libraries:** See `Software_Reference.md` → "Required Libraries"
- **Pin assignments:** See `Hardware_Reference.md` → "Pinout & Wiring Map"
- **Coding examples:** See `Software_Reference.md` for complete code patterns

## Version Control
- Commit working features atomically
- Tag releases with semantic versioning
- Update Hardware_Reference.md or Software_Reference.md BEFORE committing major features
- Include hardware revision in commit messages if relevant

## When In Doubt
1. Check Hardware_Reference.md for physical connections and voltage levels
2. Check Software_Reference.md for code architecture and safety patterns
3. Review reference implementations (Morse Code Controller.mdc, Audio Controller Code.mdc)
4. Prioritize safety and non-blocking design
5. Test with oscilloscope/logic analyzer for timing verification
6. Document assumptions and ask for clarification

---

**Remember:** This is safety-critical code. A stuck PTT can drain batteries, overheat equipment, or cause interference. Always implement defensive programming practices.
